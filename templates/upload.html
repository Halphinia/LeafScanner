{% extends "base.html" %}

{% block content %}
<div>
    <h1 style="text-align: center; padding-bottom: 20px;">
        Upload items here
    </h1>
</div>
<!-- Drag & Drop Upload Block -->
<form id="upload-form" action="/upload" method="POST" enctype="multipart/form-data" class="mx-auto" style="max-width: 720px;">
  <!-- Hidden file input -->
  <input id="file-input" type="file" name="files" multiple hidden>

  <!-- Dropzone (clickable) -->
  <label id="dropzone" for="file-input" class="dropzone d-flex flex-column justify-content-center align-items-center text-center">
    <svg aria-hidden="true" width="72" height="72" viewBox="0 0 24 24" fill="none" stroke="currentColor"
         stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="12" y1="5" x2="12" y2="19"></line>
      <line x1="5" y1="12" x2="19" y2="12"></line>
    </svg>
    <div class="mt-3">
      <div class="fw-semibold">Drag & drop files here</div>
      <div class="text-muted small">or click to select</div>
    </div>
  </label>

  <!-- Manual upload button -->
  <div class="text-center mt-3">
    <button type="button" id="browse-btn" class="btn btn-primary">Choose files</button>
  </div>

  <!-- File list -->
  <ul id="file-list" class="list-group list-group-flush mt-3"></ul>

    <!-- Submit button -->
  <div class="text-center mt-4">
    <button type="submit" class="btn btn-success">Upload Files</button>
  </div>

</form>

<style>
  .dropzone {
    border: 2px dashed #6c757d;
    border-radius: 16px;
    min-height: 240px;
    background: #f8f9fa;
    color: #495057;
    cursor: pointer;
    transition: background-color .2s, border-color .2s, box-shadow .2s;
    user-select: none;
  }
  .dropzone:hover,
  .dropzone:focus-within {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13,110,253,.15);
  }
  .dropzone.dragover {
    background: #e7f1ff;
    border-color: #0d6efd;
  }
  .remove-btn {
    cursor: pointer;
    color: #dc3545;
    font-weight: bold;
    margin-left: auto;
  }
</style>

<script>
(function () {
  const dropzone = document.getElementById('dropzone');
  const input    = document.getElementById('file-input');
  const browse   = document.getElementById('browse-btn');
  const list     = document.getElementById('file-list');

  let files = [];
  browse.addEventListener('click', () => input.click());

  function renderList() {
    list.innerHTML = '';
    files.forEach((file, idx) => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex align-items-center';
      const span = document.createElement('span');
      span.textContent = file.webkitRelativePath || file.name;
      const remove = document.createElement('span');
      remove.innerHTML = '&times;';
      remove.className = 'remove-btn ms-2';
      remove.addEventListener('click', () => {
        files.splice(idx, 1);
        updateInput();
        renderList();
      });
      li.appendChild(span);
      li.appendChild(remove);
      list.appendChild(li);
    });
  }

  function updateInput() {
    const dt = new DataTransfer();
    files.forEach(f => dt.items.add(f));
    input.files = dt.files;
  }

  input.addEventListener('change', () => {
    files = [...files, ...input.files];
    updateInput();
    renderList();
  });

  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt =>
    dropzone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); })
  );
  ['dragenter', 'dragover'].forEach(evt =>
    dropzone.addEventListener(evt, () => dropzone.classList.add('dragover'))
  );
  ['dragleave', 'drop'].forEach(evt =>
    dropzone.addEventListener(evt, () => dropzone.classList.remove('dragover'))
  );

  dropzone.addEventListener('drop', async e => {
    const items = e.dataTransfer.items;
    if (!items) return;

    const picked = [];
    await Promise.all(
      [...items].map(item => {
        const entry = item.webkitGetAsEntry && item.webkitGetAsEntry();
        if (!entry) return;
        return traverseEntry(entry, "");
      })
    );

    function traverseEntry(entry, path) {
      return new Promise(resolve => {
        if (entry.isFile) {
          entry.file(file => {

            const relPath = path ? `${path}/${file.name}` : file.name;
            const fileWithPath = new File([file], file.name, {
              type: file.type,
              lastModified: file.lastModified
            });

            Object.defineProperty(fileWithPath, 'webkitRelativePath', { value: relPath });
            picked.push(fileWithPath);
            resolve();
          });
        } else if (entry.isDirectory) {
          const reader = entry.createReader();
          const readAll = () => {
            reader.readEntries(async entries => {
              if (!entries.length) return resolve();
              await Promise.all(entries.map(child => traverseEntry(child, path ? `${path}/${entry.name}` : entry.name)));
              readAll();
            });
          };
          readAll();
        } else {
          resolve();
        }
      });
    }

    files = [...files, ...picked];
    updateInput();
    renderList();
  });
})();
</script>



{% endblock %}
